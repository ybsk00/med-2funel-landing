# [AntiGravity 작업지시서] 마케팅 트래킹 + UTM 생성기 + 퍼널 KPI (관리자 단일 메뉴)

## 0. 목표
신규 “마케팅 툴”을 별도 모듈로 구축한다. 기존 서비스 도메인의 퍼널 흐름(퍼널1/퍼널2/예약)을 30일 어트리뷰션 기준으로 추적하고, 관리자(Admin) 대시보드 **단일 메뉴**에서 KPI/일간/전환상세/UTM 생성/실험(A/B)을 운영할 수 있게 한다.

- 기존 업무/진료 DB와 직접 결합하지 않는다.
- 단, “예약 전환”을 최종 목표로 보기 위해 예약 생성 시점에서 전환 이벤트만 기록한다(예약 DB를 변경하거나 조인할 필요 없음. 예약 생성 API에서 마케팅 이벤트를 추가로 기록하는 방식).

---

## 1. 기본 원칙
### 1.1 추적 방식
- 1st-party 트래킹(자사 도메인) 기반
- 식별자: `visitor_id`(익명) + `session_id` + `user_id`(로그인 후)
- 로그인 성공 시 `visitor_id ↔ user_id`를 연결
- 전환(예약) 발생 시점 기준 과거 30일 내 터치 중 **Last Touch**를 기본 기여로 확정 (First Touch도 스냅샷 저장)

### 1.2 KPI 정의(필수)
- F1→F2 전환율 = `f2_enter / f1_view`
- F2→예약 전환율 = `reservation_created / f2_enter`
- F1→예약 전환율 = `reservation_created / f1_view`
- 마찰 분석: CTA 클릭률 / 로그인완료율 / 예약시도→완료율(옵션)

---

## 2. 관리자 메뉴(단일 메뉴) IA
메뉴명: **마케팅 트래킹**

탭 구성(하나의 메뉴 내부 탭):
1) **KPI 요약**
2) **일간 추이**
3) **전환(예약) 상세**
4) **UTM 생성기**
5) **실험(A/B) & 버전관리** *(고도화, 2차 가능)*

---

## 3. 이벤트 표준(고정)
아래 이벤트 명칭은 변경 없이 고정한다.

### 3.1 퍼널1(F1)
- `f1_view` : 퍼널1 랜딩 진입
- `f1_chat_start` : 퍼널1 상담 시작(옵션)
- `f1_cta_login_click` : “로그인/메디컬로 이동” CTA 클릭(마찰 분석용)

### 3.2 퍼널2(F2)
- `f2_enter` : 로그인 성공 후 퍼널2 진입(권장: login success 기준)
- `reservation_modal_open` : 예약 모달 열림(옵션)
- `reservation_created` : 예약 생성(최종 전환)

---

## 4. 신규 DB 스키마(마케팅 모듈 전용)
> 기존 DB와 별개로 “마케팅 툴 전용 테이블”을 생성한다.
> Supabase(Postgres) 기준 SQL 작성.

### 4.1 원천 이벤트 로그
테이블: `marketing_events`

필드(권장):
- `id` uuid pk default gen_random_uuid()
- `created_at` timestamptz default now()
- `visitor_id` text not null
- `session_id` text not null
- `user_id` uuid null
- `event_name` text not null
- `page_url` text null
- `landing_url` text null
- `referrer` text null
- `utm_source` text null
- `utm_medium` text null
- `utm_campaign` text null
- `utm_content` text null
- `utm_term` text null
- `sub1` text null  (기타1)
- `sub2` text null  (기타2)
- `click_ids` jsonb null (gclid/fbclid/naver 등)
- `prompt_version_id` text null
- `flow_version_id` text null
- `metadata` jsonb null

인덱스:
- (created_at)
- (event_name, created_at)
- (visitor_id, created_at)
- (user_id, created_at)
- (utm_source, utm_campaign, created_at)

### 4.2 전환 확정(어트리뷰션 결과)
테이블: `marketing_conversions`

필드(권장):
- `id` uuid pk default gen_random_uuid()
- `created_at` timestamptz default now()
- `user_id` uuid null
- `visitor_id` text null
- `reservation_id` text not null  (기존 예약 pk를 string으로 스냅샷만 저장)
- `attributed_event_id` uuid null  (last touch event id)
- `last_touch` jsonb not null  (utm/referrer/sub1/sub2/click_ids 스냅샷)
- `first_touch` jsonb null       (최초 유입 스냅샷)
- `path_summary` text null       (간단 경로 요약)

인덱스:
- (created_at)
- (reservation_id)
- (user_id, created_at)

### 4.3 UTM 생성기 이력(선택)
테이블: `utm_links`

필드(권장):
- id uuid pk default gen_random_uuid()
- created_at timestamptz default now()
- created_by uuid null (admin user)
- channel text not null (meta/google/naver/blog/other)
- landing_url text not null
- final_url text not null
- utm_source text not null
- utm_medium text not null
- utm_campaign text not null
- utm_content text not null
- utm_term text null
- sub1 text null
- sub2 text null
- memo text null

### 4.4 프롬프트/실험(고도화, 2차)
- `prompt_versions`
- `flow_versions`
- `experiments`
- `experiment_variants`

---

## 5. RLS/권한 정책
- 관리자 페이지만 조회 가능
- `marketing_events`, `marketing_conversions`, `utm_links`는 **Admin role만 SELECT**
- 트래킹 수집(INSERT)은 public 허용하되, RLS 정책으로 **INSERT만 허용**
- Admin 식별은 프로젝트의 기존 Admin 정책을 그대로 활용(예: is_admin claim / admin_users 테이블 등). 불명확하면 “Admin only page 접근권한” 방식과 동일하게 맞춘다.

---

## 6. API 라우트 설계(Next.js App Router 기준)
> 경로는 프로젝트 구조에 맞게 `/app/api/.../route.ts`로 구현한다.

### 6.1 이벤트 수집
- `POST /api/marketing/track`
  - body: visitor_id, session_id, user_id(선택), event_name, page_url, landing_url, referrer, utm_*, sub1/sub2, click_ids, metadata, prompt_version_id/flow_version_id
  - action: `marketing_events` insert
  - 필수: basic rate limit(간단 구현 가능하면) + 필드 길이 제한

### 6.2 로그인 연결(attach)
- `POST /api/marketing/attach`
  - body: visitor_id, user_id
  - action: 최신 세션의 이벤트들에 user_id를 업데이트할 필요는 없고,
    - 권장: **이후 이벤트부터 user_id를 포함**시키는 방식으로 충분
  - 단, 운영 편의를 위해 “최근 30일 visitor_id 이벤트를 user_id로 소급 연결” 옵션 제공 가능(선택)

### 6.3 예약 전환 확정
- 예약 생성 API(기존)에서 아래를 추가 호출하거나 내부 함수로 처리:
  - `POST /api/marketing/conversion`
    - body: reservation_id, user_id(가능하면), visitor_id(가능하면)
    - action:
      1) `reservation_created` 이벤트 1건 insert
      2) last touch 조회: (user_id 우선, 없으면 visitor_id) 기준 과거 30일 `marketing_events` 중 유효 터치(utm/referrer/click) 최신 1건
      3) first touch 조회: 최초 1건
      4) `marketing_conversions` insert (스냅샷 포함)

### 6.4 관리자 집계 API
- `GET /api/admin/marketing/summary?from=YYYY-MM-DD&to=YYYY-MM-DD`
  - KPI 카드용 집계 반환 (counts + rates)
- `GET /api/admin/marketing/daily?from=...&to=...`
  - 날짜별 f1_view / f2_enter / reservation_created + rates
- `GET /api/admin/marketing/conversions?date=YYYY-MM-DD&source=...&campaign=...`
  - 전환 상세 리스트
- `POST /api/admin/utm-links` (선택)
  - 생성한 UTM URL 이력 저장

---

## 7. 프론트(트래킹 스니펫) 적용 지점
### 7.1 공통 유입 처리
- 퍼널1 랜딩 진입 시:
  - URL의 utm_* / sub1/sub2 / click_id 파싱
  - `visitor_id` 생성(없으면) 후 cookie+localStorage 저장
  - `session_id` 생성/갱신
  - `track(f1_view)`

### 7.2 CTA 클릭 시
- `track(f1_cta_login_click)`

### 7.3 로그인 성공 시
- `attach(visitor_id, user_id)`
- `track(f2_enter)`

### 7.4 예약 생성 시
- 기존 예약 생성 성공 직후 `conversion(reservation_id, user_id, visitor_id)` 호출

---

## 8. 관리자 페이지 구현(단일 메뉴)
경로 예시:
- `/admin/marketing`

탭별 요구사항:
### 8.1 KPI 요약 탭
- 기간 선택: 오늘/7일/30일/커스텀
- 카드:
  - 방문(uniq visitor_id)
  - F2 진입
  - 예약
  - F1→F2, F2→예약, F1→예약 전환율
- Top breakdown:
  - utm_source / utm_campaign / utm_content 기준 Top N

### 8.2 일간 추이 탭
- 라인차트: 날짜별 f1_view, f2_enter, reservation_created
- 일간 테이블: 동일 수치 + 전환율
- 날짜 클릭 → 전환 상세 탭으로 필터 이동

### 8.3 전환(예약) 상세 탭
- 전환 리스트:
  - created_at
  - reservation_id
  - last_touch: source/medium/campaign/content/term + sub1/sub2
  - first_touch 요약
  - path_summary(있으면)
- 필터:
  - 날짜, source, campaign, content, sub1, sub2

### 8.4 UTM 생성기 탭
- 입력:
  - 채널(meta/google/naver/blog/other)
  - landing_url
  - campaignName(필수)
  - content(선택), term(선택)
  - 기타1(sub1), 기타2(sub2): 사용자 입력(선택)
  - 미입력 시 자동 생성 토글(예: `auto_sub1_xxxxxx`)
- 출력:
  - 최종 URL
  - 복사 버튼
  - (선택) 저장 버튼 → `utm_links` insert + 이력 리스트

### 8.5 실험(A/B) 탭(2차)
- prompt/flow 버전 등록 및 traffic split
- 버전별 KPI 비교
- 승격/롤백 + 변경 이력

---

## 9. 어트리뷰션(30일) 조회 규칙(정확히 구현)
- “유효 터치” 정의:
  - utm_source/utm_campaign 등이 존재하거나
  - referrer가 존재하거나
  - click_ids가 존재하면 터치로 인정
- last touch: `created_at desc limit 1`
- first touch: `created_at asc limit 1`
- window: conversion_time - 30일 ~ conversion_time

---

## 10. 성능 전략
초기 MVP:
- 관리자 집계는 SQL group by로 구현

트래픽 증가 시(고도화):
- `marketing_daily_metrics` 테이블 생성
- 하루 1회(또는 1시간) 집계 갱신 스케줄러로 대시보드 응답 속도 개선

---

## 11. 산출물 체크리스트(필수 완료 조건)
1) 신규 테이블 SQL 생성 및 RLS 적용
2) `/api/marketing/track`, `/api/marketing/attach`, `/api/marketing/conversion` 구현
3) 퍼널1/퍼널2/예약 생성 지점에 이벤트 심기 완료
4) 관리자 `/admin/marketing` 단일 메뉴 구현(최소 4탭: KPI/일간/전환/UTM)
5) KPI 산식이 화면과 API에서 일치
6) 전환 상세에서 last_touch/first_touch가 정상 표기
7) UTM 생성기에서 sub1/sub2 입력/자동생성 모두 정상 동작

---

## 12. QA 시나리오(최소)
1) UTM 생성기로 만든 URL 클릭 → `f1_view`에 utm/sub1/sub2 저장 확인
2) CTA 클릭 → `f1_cta_login_click` 저장 확인
3) 로그인 성공 → `f2_enter` 저장 확인(가능하면 user_id 포함)
4) 예약 생성 → `reservation_created` + `marketing_conversions` 생성 확인
5) 관리자 KPI에서 F1/F2/예약 카운트 및 전환율 정상 노출 확인
6) 전환 상세에서 해당 전환의 last_touch가 방금 만든 UTM인지 확인

---

## 13. 참고(UTM 채널 기본 매핑)
- meta: utm_source=meta, utm_medium=paid_social
- google: utm_source=google, utm_medium=cpc
- naver: utm_source=naver, utm_medium=cpc
- blog: utm_source=naver(or naver_blog), utm_medium=referral(or content)
- other: source/medium 사용자 입력
- utm_campaign 규칙: `{campaignName}_{yyyymm}`
- utm_content 규칙: 입력 없으면 `auto_{channel}_{shortId}`

---

## 14. 구현 메모
- “기타1/기타2”는 UTM 표준에 섞지 않고 `sub1`, `sub2`로 고정하는 것이 분석/운영에 유리하다.
- 기존 서비스 DB를 변경하지 않고도 운영 가능하되, 예약 생성 순간에 마케팅 전환 레코드를 추가로 남기는 방식으로 완결성을 확보한다.

---
끝.
