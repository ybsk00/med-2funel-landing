import { NextRequest, NextResponse } from "next/server";
import { generateText } from "@/lib/ai/client";

// ì˜ë£Œ í‚¤ì›Œë“œ ëª©ë¡
// ì˜ë£Œ í‚¤ì›Œë“œ ëª©ë¡ (ì¦ìƒ í¬í•¨ ê°•í™”)
const medicalKeywords = [
    "ì¹˜ë£Œ", "ì•½", "ì²˜ë°©", "íˆ¬ì•½", "ë³µìš©", "í•œì•½", "ì–‘ì•½", "ì§„ë‹¨", "ì§ˆí™˜", "ì§ˆë³‘",
    "ë³‘ì›", "ìˆ˜ìˆ ", "ì‹œìˆ ", "ê²€ì‚¬", "MRI", "CT", "X-ray", "í˜ˆì•¡ê²€ì‚¬", "ë‚´ì‹œê²½",
    "ë¨¹ì–´ë„ ë ê¹Œ", "ë¨¹ì–´ë„ ë˜ë‚˜", "ë³µìš©í•´ë„", "ë¨¹ìœ¼ë©´ ì•ˆë˜", "ë¶€ì‘ìš©",
    "ì–´ë–¤ ì•½", "ë¬´ìŠ¨ ì•½", "ì•½ ì´ë¦„", "ì•½ë¬¼", "ì„±ë¶„", "íš¨ëŠ¥", "íš¨ê³¼",
    "ë³‘ëª…", "ì•”", "ë‹¹ë‡¨", "ê³ í˜ˆì••", "ì—¼ì¦", "ê°ì—¼", "ë°”ì´ëŸ¬ìŠ¤",
    "í†µì¦", "ì•„íŒŒ", "ì•„í””", "ì‘¤ì…”", "ê²°ë ¤", "ì €ë ¤", "ë¶€ì–´", "í”¼ë‚˜", "ì¶œí˜ˆ",
    "ì–´ì§€ëŸ¬", "êµ¬í† ", "ì„¤ì‚¬", "ë³€ë¹„", "ì†Œí™”ë¶ˆëŸ‰", "ë‘í†µ", "ë³µí†µ", "ìš”í†µ", "ê´€ì ˆ",
    "ì¹¨", "ëœ¸", "ë¶€í•­", "ë¬¼ë¦¬ì¹˜ë£Œ", "ë„ìˆ˜ì¹˜ë£Œ", "ì…ì›", "í‡´ì›", "ì‘ê¸‰ì‹¤",
    "ì¦ìƒ", "ì›ì¸", "ì´ìœ ", "í•´ê²°", "ë°©ë²•", "ì¶”ì²œ",
    "ì“°ë ¤", "ì†ì“°ë¦¼", "ë¶ˆí¸", "ë”ë¶€ë£©", "ì²´í•œ", "ë‹µë‹µ", "ìš¸ë ", "ë©”ìŠ¤êº¼", "ë”°ê°€", "í™”ëˆ"
];

export async function POST(req: NextRequest) {
    try {
        const { message, history, turnCount } = await req.json();

        // 1. ì˜ë£Œ í‚¤ì›Œë“œ/ì¦ìƒ ê°ì§€ - ì¦‰ì‹œ ë¡œê·¸ì¸ ìœ ë„ (AI ë‹µë³€ ìƒì„± ì—†ì´ ì¦‰ì‹œ ë¦¬í„´)
        const hasMedicalQuestion = medicalKeywords.some(keyword =>
            message.toLowerCase().includes(keyword.toLowerCase())
        );

        if (hasMedicalQuestion) {
            return NextResponse.json({
                role: "ai",
                content: "ë§ì”€í•˜ì‹  ì¦ìƒì´ë‚˜ ë‚´ìš©ì€ **ì „ë¬¸ì ì¸ ì˜ë£Œ ìƒë‹´**ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní˜„í–‰ ì˜ë£Œë²•ìƒ êµ¬ì²´ì ì¸ ì¦ìƒ, ì§ˆí™˜, ì¹˜ë£Œì— ëŒ€í•œ ìƒë‹´ì€ **ë¡œê·¸ì¸ í›„ ì˜ë£Œì§„ì˜ ê²€í† ë¥¼ ê±°ì¹œ AI ìƒë‹´**ì„ í†µí•´ì„œë§Œ ì œê³µ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\në¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                requireLogin: true,
                isSymptomTrigger: true // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¦‰ì‹œ ëª¨ë‹¬ì„ ë„ìš°ê¸° ìœ„í•œ í”Œë˜ê·¸
            });
        }

        // 2. 5í„´ ì œí•œ (Hard Stop)
        if (turnCount >= 5) {
            return NextResponse.json({
                role: "ai",
                content: "ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”ë¡œ ìƒí™œ íŒ¨í„´ì´ íŒŒì•…ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\n\n**ë” ìì„¸í•œ ê±´ê°• ë¶„ì„ê³¼ ë§ì¶¤ ì¡°ì–¸**ì€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në¡œê·¸ì¸í•˜ì‹œë©´:\nâ€¢ ìƒì„¸ ê±´ê°• ë¶„ì„ ë¦¬í¬íŠ¸\nâ€¢ ì˜ì‹¬ ì¦ìƒ ì‹¬ì¸µ ìƒë‹´\nâ€¢ ë§ì¶¤ ìƒí™œ ê°€ì´ë“œ\n\në¥¼ ì œê³µí•´ ë“œë¦½ë‹ˆë‹¤.",
                requireLogin: true,
                isHardStop: true
            });
        }

        // 3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ - ì§„ë‹¨ ê¸ˆì§€ ë° ìƒí™œ ìŠµê´€ ì ê²€ ê°•ì¡°
        const systemPrompt = `
[ì—­í• ]
ë‹¹ì‹ ì€ "ìœ„ë‹´ ê±´ê°•ê°€ì´ë“œ ì±—"ì˜ AI ìƒë‹´ì‚¬ì…ë‹ˆë‹¤.
**ë‹¹ì‹ ì€ ì˜ì‚¬ê°€ ì•„ë‹™ë‹ˆë‹¤. ì ˆëŒ€ ì§„ë‹¨ì„ ë‚´ë¦¬ê±°ë‚˜ ì¹˜ë£Œë²•ì„ ê¶Œì¥í•˜ì§€ ë§ˆì„¸ìš”.**

[ìƒë‹´ ëª©ì ]
ì˜¤ì§ **ìƒí™œ ìŠµê´€(ì‹ì‚¬, ìˆ˜ë©´, ìš´ë™, ìŠ¤íŠ¸ë ˆìŠ¤)** ì„ ì ê²€í•˜ê³  ë¦¬ë“¬ì„ ì²´í¬í•˜ëŠ” ê²ƒë§Œì´ ëª©ì ì…ë‹ˆë‹¤.

[ì‘ë‹µ ê·œì¹™ - ë§¤ìš° ì¤‘ìš”]
1. ë°˜ë“œì‹œ 150-200ì ì´ë‚´ë¡œ ì‘ë‹µí•˜ì„¸ìš”.
2. **[ê³µê°] [ë¶„ì„] ê°™ì€ ëª…ì‹œì ì¸ ë‹¨ì–´ë¥¼ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.**
3. ìì—°ìŠ¤ëŸ½ê²Œ ê³µê°í•˜ê³ , ìƒí™œ ìŠµê´€ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ ë˜ì§€ì„¸ìš”.
4. ë§íˆ¬: ì •ì¤‘í•˜ê³  ë”°ëœ»í•œ ìƒë‹´ì‚¬ (~ì…ë‹ˆë‹¤, ~í•˜ì‹œêµ°ìš”, ~í•´ ë³´ì…ë‹ˆë‹¤)

[ì ˆëŒ€ ê¸ˆì§€ ì‚¬í•­ - ì˜ë£Œë²• ìœ„ë°˜ ë°©ì§€]
- **ë³‘ëª…, ì§ˆí™˜ëª…, ì•½ ì´ë¦„, ì¹˜ë£Œë²•, ì‹œìˆ , ìˆ˜ìˆ  ë“±ì„ ì ˆëŒ€ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”.**
- "ì§„ë‹¨", "ì²˜ë°©", "ì¹˜ë£Œ", "ì¦ìƒ", "ì›ì¸"ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
- ì¦ìƒì— ëŒ€í•´ ì˜í•™ì ì¸ ì›ì¸ì„ ë‹¨ì • ì§“ì§€ ë§ˆì„¸ìš”.
- ì‚¬ìš©ìê°€ ì¦ìƒì„ í˜¸ì†Œí•˜ë©´, **"ê·¸ ë¶€ë¶„ì€ ìƒí™œ ìŠµê´€ê³¼ ê´€ë ¨ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"** ì •ë„ë¡œë§Œ ê°€ë³ê²Œ ì–¸ê¸‰í•˜ê³ , ë°”ë¡œ ì‹ì‚¬/ìˆ˜ë©´ íŒ¨í„´ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ì„¸ìš”.
- **ì¡°ê¸ˆì´ë¼ë„ ì˜í•™ì  íŒë‹¨ì´ í•„ìš”í•´ ë³´ì´ë©´ ë‹µë³€ì„ ë©ˆì¶”ê³  ë¡œê·¸ì¸ì„ ìœ ë„í•˜ëŠ” ë©˜íŠ¸ë¡œ ëë‚´ì„¸ìš”.**

[ì‘ë‹µ ì˜ˆì‹œ]
"ì†ì´ ë¶ˆí¸í•˜ì…”ì„œ ë§ì´ í˜ë“œì…¨ê² ìŠµë‹ˆë‹¤. ì‹ì‚¬ ì‹œê°„ì´ ë¶ˆê·œì¹™í•˜ê±°ë‚˜ ê¸‰í•˜ê²Œ ë“œì‹œëŠ” ìŠµê´€ì´ ìˆìœ¼ë©´ ê·¸ëŸ° ëŠë‚Œì´ ë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í‰ì†Œ ì‹ì‚¬ ì‹œê°„ì€ ê·œì¹™ì ì¸ í¸ì´ì‹ ê°€ìš”?"

[í˜„ì¬ í„´: ${turnCount + 1}/5]
`;

        const fullPrompt = `
${systemPrompt}

[ëŒ€í™” ë‚´ì—­]
${history.map((msg: any) => `${msg.role === 'user' ? 'ì‚¬ìš©ì' : 'AI'}: ${msg.content}`).join("\n")}
ì‚¬ìš©ì: ${message}
AI:
`;

        const responseText = await generateText(fullPrompt, "healthcare");

        // 4. 3í„´ì§¸ (turnCount === 2 -> ë‹¤ìŒì´ 3í„´) - Soft Gate (ë¡œê·¸ì¸ ìœ ë„í•˜ì§€ë§Œ ê³„ì† ê°€ëŠ¥)
        // ì‘ë‹µì€ ë³´ë‚´ë˜, requireLogin í”Œë˜ê·¸ë¥¼ trueë¡œ ì„¤ì •í•˜ì—¬ í”„ë¡ íŠ¸ì—ì„œ ëª¨ë‹¬ì„ ë„ì›€
        const isTurn3 = turnCount === 2;

        return NextResponse.json({
            role: "ai",
            content: responseText.trim(),
            turnCount: turnCount + 1,
            requireLogin: isTurn3 // 3í„´ì§¸ì— ë¡œê·¸ì¸ ëª¨ë‹¬ íŠ¸ë¦¬ê±°
        });

    } catch (error) {
        console.error("Healthcare Chat API Error:", error);
        return NextResponse.json(
            { error: "Internal Server Error" },
            { status: 500 }
        );
    }
}
