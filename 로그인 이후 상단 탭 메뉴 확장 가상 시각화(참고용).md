# 로그인 이후 상단 탭 메뉴 확장 + “가상 시각화(참고용)” 모달 플로우 구현 기획안 (AntiGravity 작업용)

목적: 로그인 이후(회원 영역)에서 기존 상단 탭(챗봇 등) 구조를 유지하면서, **새 메뉴(가상 시각화)**를 추가한다.  
사용자는 상단 탭 클릭 → **모달 오픈** → 동의 확인 → 사진 업로드 → 생성 → 탭 전환(결과 보기)까지 **모달 안에서 완료**한다.

중요(리스크 최소화):
- “필러/보톡스/레이저 효과” 같은 단정형 표현은 UI에서 사용하지 않는다.
- “참고용 시각화이며 실제 시술 결과를 예측/보장하지 않습니다” 고지를 모달 하단에 상시 노출한다.

---

## 1) 현재(로그인 이후) UI 가정

- 로그인 이후 페이지에 **상단 탭 메뉴**가 존재  
  예: `챗봇`, `루틴`, `피부과 찾기`, … (기존 유지)
- 탭 클릭 시 라우팅 또는 모달/패널이 열리는 구조가 일부 존재
- 목표: 이 상단 탭에 **새 탭 1개 추가**하고, 클릭 시 모달로 전체 플로우 진행

---

## 2) 신규 상단 탭 메뉴 정의

### 2-1. 메뉴명(권장)
- 탭 라벨: `가상 시각화`
- 보조 설명(툴팁/서브): `참고용`

> “시술/효과/개선” 같은 단어는 라벨에 쓰지 않는다.

### 2-2. 동작
- 상단 탭 `가상 시각화` 클릭 → `FaceSimulationModal` 오픈
- 모달 안에서:
  1) 동의 확인/저장
  2) 업로드
  3) 생성
  4) 결과 탭 전환
  5) 삭제

---

## 3) 모달 UX 설계 (핵심)

### 3-1. 모달 헤더
- 타이틀: `가상 시각화(참고용)`
- 서브텍스트(작게): `내 사진을 기반으로 피부 표현을 시각화합니다.`
- 우측: 닫기(X)

### 3-2. 모달 스텝(단일 화면, 상태 기반 전환)
모달은 페이지 전환 없이 상태로만 바뀐다.

**STATE 1: ConsentGate (필수)**
- 체크박스 2~3개
  - (필수) `얼굴 사진 처리 및 저장(최대 보관기간) 동의`
  - (필수) `참고용 시각화이며 결과를 보장하지 않음에 동의`
  - (선택) `서비스 개선을 위한 익명 통계 사용 동의`
- 버튼: `동의하고 진행`
- 동의 완료 시 STATE 2로 전환

**STATE 2: PhotoUploader**
- 업로드 영역(드래그 앤 드롭)
- 제한: jpg/png, 8MB
- 안내: `정면 사진 권장 · 배경은 크게 중요하지 않습니다`
- 업로드 완료 시 자동으로 STATE 3(생성 중)으로 전환 또는 “생성 시작” 버튼

**STATE 3: ProgressPanel**
- 상태 텍스트:
  - `이미지 처리 중입니다… (약 10~30초)`
- 로딩 스피너 + 단계 표시(업로드 → 처리 → 완료)
- 완료 시 STATE 4로 전환

**STATE 4: Result Viewer (탭 4개)**
- 탭(안전한 네이밍):
  - `결·톤 정돈(가상)`
  - `표정주름 완화 표현(가상)`
  - `볼륨감 변화 표현(가상)`
  - `광채 글로우(가상)`
- 결과 이미지: 탭 전환 crossfade 300ms
- 반전 체감 강화를 위해 최소 1개 적용:
  - (권장) Before/After 슬라이더(기본)
  - ROI 점선 표시(눈가/미간/팔자 등)
- CTA(모달 하단): `피부 상담 연결` 또는 `예약/문의` (선택 사항)
- 삭제 버튼: `내 사진 삭제` (즉시 삭제)

### 3-3. 모달 하단 고지(상시 고정)
- 배지: `참고용 안내 · 진단/처방 아님`
- 고지 문구(1줄):
  - `참고용 시각화이며 실제 시술 결과를 예측/보장하지 않습니다. 개인 상태에 따라 달라질 수 있습니다.`

---

## 4) 기술 구현 설계 (모달 기반)

### 4-1. 데이터 구조(기존 테이블 확장 그대로 사용)
- `user_consents` : 사용자별 동의 저장
- `face_style_sessions` : 업로드/생성 세션
- `face_style_variants` : 결과 4종

variant_key:
- `texture_tone`
- `wrinkle_soften`
- `volume_expression`
- `glow`

### 4-2. Storage
- bucket: `face-style` (private)
- path:
  - `face-style/{user_id}/{session_id}/original.jpg`
  - `face-style/{user_id}/{session_id}/{variant_key}.jpg`
- Signed URL만 사용

### 4-3. API (기존 4개 유지)
1) `POST /api/face-style/session/create`
   - Output: `{ sessionId, signedUploadUrl, objectPath }`

2) `POST /api/face-style/session/mark-uploaded`
   - Input: `{ sessionId }`
   - 서버: variants 4개 queued 생성

3) `POST /api/face-style/session/generate`
   - Input: `{ sessionId }`
   - 서버: Sharp 기반(또는 후속 고급 방식)으로 4개 variant 생성 → 업로드 → DB update

4) `GET /api/face-style/session/get?sessionId=...`
   - Output: `{ session, variants: { ...signedUrls } }`

> 모달 내부에서는 위 API를 순서대로 호출하며 상태 UI만 바꾼다.

---

## 5) 프론트엔드 컴포넌트 구성 (모달 중심)

### 5-1. 상단 탭 메뉴 확장
- `[MODIFY] 상단 탭 컴포넌트` (예: `TopTabs.tsx` 또는 `HeaderTabs.tsx`)
  - 탭 추가: `가상 시각화`
  - onClick: `setFaceModalOpen(true)`

### 5-2. 모달(새 컴포넌트)
- `[NEW] src/components/face-style/FaceSimulationModal.tsx`
  - 내부 상태 머신:
    - `step = 'consent' | 'upload' | 'generating' | 'result'`
  - 내부에서 아래 컴포넌트 사용(또는 모달 내부 구현)

### 5-3. 모달 내부 컴포넌트(재사용 권장)
- `ConsentGate.tsx`
- `PhotoUploader.tsx`
- `ProgressPanel.tsx`
- `FaceSwapViewer.tsx` (탭 4개 + crossfade)
- `BeforeAfterSlider.tsx` (선택, 강력 권장)
- `DeleteMyPhotosButton.tsx`

---

## 6) 동작 상세(상태 전이)

### 6-1. 탭 클릭 시
- `FaceSimulationModal` 오픈
- 서버에서 `user_consents` 조회
  - 동의 완료면 `step='upload'`
  - 동의 미완료면 `step='consent'`

### 6-2. 업로드 플로우
1) `create` 호출 → signedUploadUrl 수령
2) 클라이언트가 storage 업로드(직접 PUT)
3) `mark-uploaded` 호출
4) `generate` 호출
5) `get` 폴링 또는 generate 완료 후 get 호출 → 결과 URL 수령
6) `step='result'`

> 폴링 권장: generate가 비동기면 2~3초 간격 최대 30초

### 6-3. 삭제 플로우
- `DeleteMyPhotosButton` 클릭 시:
  - storage 원본/variants 삭제
  - DB 세션/variants 삭제 또는 상태값 삭제 처리
  - 모달 상태 초기화(`step='upload'`)

---

## 7) UI 카피(바로 붙여넣기)

### 7-1. 상단 탭
- `가상 시각화`

### 7-2. 모달 타이틀/버튼
- 타이틀: `가상 시각화(참고용)`
- 동의 버튼: `동의하고 진행`
- 업로드 버튼: `사진 업로드`
- 결과 CTA: `내 사진 삭제`
- 고지 배지: `참고용 안내 · 진단/처방 아님`
- 고지 문구:
  - `참고용 시각화이며 실제 시술 결과를 예측/보장하지 않습니다. 개인 상태에 따라 달라질 수 있습니다.`

### 7-3. 결과 탭 라벨(안전 버전)
- `결·톤 정돈(가상)`
- `표정주름 완화 표현(가상)`
- `볼륨감 변화 표현(가상)`
- `광채 글로우(가상)`

---

## 8) 개발 순서(권장)

1) 상단 탭에 `가상 시각화` 추가 + 모달 오픈 연결
2) `FaceSimulationModal` 뼈대 + step 상태 머신 구현
3) ConsentGate 연결 + user_consents 저장
4) create/업로드/mark-uploaded API 연동
5) generate/get 연동 + 결과 탭 전환 UI
6) Before/After 슬라이더(반전 강화)
7) DeleteMyPhotosButton(스토리지/DB 정리)
8) 보관 정책(원본 24h, 결과 30d) 크론 추가

---

## 9) 최종 파일 트리(모달 중심)

src/
├── components/
│   ├── layout/
│   │   └── TopTabs.tsx                # [MODIFY] 상단 탭에 가상 시각화 추가
│   └── face-style/
│       ├── FaceSimulationModal.tsx     # [NEW] 모달 전체 플로우
│       ├── ConsentGate.tsx             # [NEW/REUSE]
│       ├── PhotoUploader.tsx           # [NEW/REUSE]
│       ├── ProgressPanel.tsx           # [NEW/REUSE]
│       ├── FaceSwapViewer.tsx          # [NEW/REUSE]
│       ├── BeforeAfterSlider.tsx       # [NEW] (권장)
│       └── DeleteMyPhotosButton.tsx    # [NEW/REUSE]
├── app/
│   └── api/
│       └── face-style/
│           └── session/
│               ├── create/route.ts
│               ├── mark-uploaded/route.ts
│               ├── generate/route.ts
│               └── get/route.ts
└── supabase/
    └── migrations/
        └── 20251227_face_style_tables.sql

---

## 10) 검증 체크리스트

- 상단 탭 `가상 시각화` 클릭 시 모달이 열린다
- 동의 미완료 시: 동의 화면만 보이고 업로드가 막힌다
- 동의 완료 후: 업로드 가능
- 업로드 후: generating 표시 → 완료 시 결과 탭 4개 전환 가능
- 고지 문구가 모달 하단에 항상 노출된다
- 삭제 버튼으로 원본/결과가 즉시 삭제된다
- 모달 닫았다 다시 열어도 상태가 정상(최근 세션 복구 또는 초기화 정책 선택)

---

## 11) 정책 메모(중요)
- UI 텍스트에 “시술 결과 보장/예측” 뉘앙스 금지
- “전후(시술결과)”로 오인될 연출은 최소화
- 로그인 이후라도 외부 광고/랜딩에 해당 결과를 그대로 노출하지 않는다(샘플만 사용)
