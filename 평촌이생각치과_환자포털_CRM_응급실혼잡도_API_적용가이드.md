# 평촌이생각치과 환자포털/CRM App 적용 가이드  
## 공공데이터 기반 “응급실(응급의료기관) 혼잡도(추정) 조회” 기능 기획/연동 문서 (v1)

> 목적: 환자포털/CRM App 내에서 **‘응급 상황 시 빠른 의사결정’**을 돕기 위해, 공공데이터(국립중앙의료원/중앙응급의료센터 계열)의 **실시간 가용자원(가용병상 등)** 정보를 조회하고, 이를 **혼잡도 등급(추정)** 으로 시각화하여 안내한다.  
> 주의: 본 기능은 **진단/치료/처방/응급판정**을 수행하지 않으며, **정보 제공/안내 목적**이다.

---

## 1. 왜 치과 환자포털에 ‘응급실 혼잡도’가 필요한가 (세일즈/운영 포인트)

### 1.1 환자 관점
- 야간·휴일·심한 통증/출혈 등으로 **‘지금 어디로 가야 하지?’**가 가장 큰 불안 요인.
- 치과 진료가 적절한 상황인지, 응급의료기관 방문이 필요한 상황인지 **‘정보 접근’**이 우선.

### 1.2 병원(평촌이생각치과) 관점
- **리스크 커뮤니케이션(안전 안내)** 강화: 응급상황 시 “근처 응급의료기관 정보 안내”는 의료법상 **정보 제공(공익적 안내)** 범주로 운용 가능성이 높음(단, 표현 주의).
- 콜센터/상담 채널로 몰리는 야간 문의를 **가이드/분기**하여 운영 효율 향상.
- “환자 안전을 우선하는 병원” 인식 제고(브랜드 신뢰도 강화).

---

## 2. 기능 범위 정의 (Scope)

### 2.1 제공 기능 (MVP)
1) **근처 응급의료기관 목록 조회**  
- 위치(사용자 GPS 또는 입력 주소) 기반
- 기관명/거리/전화/주소/가용자원(가능 시)/혼잡도 등급(추정) 표기

2) **혼잡도(추정) 등급화**  
- 공공데이터가 제공하는 “가용병상/가용응급실 자원” 등을 기반으로 내부 로직으로 계산  
- 예: `여유 / 보통 / 혼잡`(3단계) 또는 `Green/Yellow/Red`(3단계)

3) **‘응급 안내’ 진입 동선**  
- 환자포털 내:  
  - (A) 하단 메뉴: “응급 안내”  
  - (B) 치아 통증/출혈 관련 FAQ 카드: “응급일 수 있어요? 가까운 응급의료기관 확인”  
  - (C) 챗봇에서 레드플래그 키워드(예: 호흡곤란, 의식저하 등) 감지 시: “응급 안내 보기” 버튼

> **중요**: 레드플래그 감지는 “판정”이 아니라, “안전 안내 문구 + 응급기관 정보 페이지로 이동”만 수행.

### 2.2 제외 기능(초기)
- “실시간 대기시간/혼잡도 %”를 공공데이터가 직접 제공하지 않는 경우가 많음 → **추정 등급**만 제공
- 병원 간 우열 비교/추천 표현 금지(의료광고 오인 리스크)
- 사용자의 상태를 기반으로 ‘응급’ 여부를 확정하는 문구/로직 금지

---

## 3. UI/UX 설계 (환자포털/CRM App 반영)

### 3.1 정보구조(IA) 제안
- 환자포털 홈
  - 카드: “응급 안내(야간/휴일)”
- 메뉴
  - “응급 안내”
    - “가까운 응급의료기관 찾기”
    - “위급 시 행동 요령(참고용)”
- 챗봇/헬스케어
  - 안전 문구 + “응급 안내 보기” CTA (필요 시)

### 3.2 화면 구성 (예시)
**[응급 안내 메인]**
- 상단 경고(고정):
  - “본 페이지는 정보 제공 목적이며, 위급하다고 판단되면 119 또는 가까운 응급실로 연락하세요.”
- 검색/필터:
  - 내 위치 사용(권한 요청) / 주소 입력
  - 반경(3km/5km/10km)
- 결과 카드(리스트):
  - 기관명 / 거리 / 전화 버튼 / 길찾기 버튼
  - 혼잡도 등급(여유/보통/혼잡) + “추정” 배지
  - 업데이트 시각(캐시 기준)

**[기관 상세]**
- 기관명, 주소, 전화, 지도
- 가용자원(응급실 가용병상 등 제공 시)
- “혼잡도는 공공데이터 기반 추정치이며 실제와 다를 수 있음” 고지

### 3.3 카피(오인 방지 문구)
- “응급실 혼잡도(추정)” / “실시간 가용자원 기반”
- “진단/치료/처방이 아닌 참고 정보”
- “증상이 위급하면 지체 없이 119 또는 응급실로 연락”

---

## 4. 데이터/기술 설계

### 4.1 데이터 출처(권장)
- 공공데이터포털에서 **국립중앙의료원/중앙응급의료센터** 계열 “응급의료기관 정보” OpenAPI를 활용  
- 제공 항목은 API별로 상이할 수 있으므로, “실시간 가용병상/수용가능” 필드 포함 여부를 기준으로 선택

> 실제 적용 시: 공공데이터포털에서 “응급의료기관”, “가용병상”, “실시간”, “중증질환 수용가능” 등의 키워드로 검색 후 활용신청.

### 4.2 인증키(서비스키) 발급 절차 요약
1) data.go.kr 로그인  
2) 해당 OpenAPI 상세 페이지 → **활용신청**  
3) 승인 후 마이페이지 → OpenAPI → **인증키(서비스키) 확인**  
4) 운영환경에서는 **서버(백엔드)에서만** 키 사용(프론트 노출 금지)

### 4.3 권장 아키텍처 (Next.js/Vercel + Supabase 기준)
- **Client(App/Web)** → **Server API Route(/api/emergency/nearby)** → **공공데이터 OpenAPI**  
- 서버에서:
  - 키 관리(ENV)
  - XML 파싱 → JSON 변환
  - 혼잡도 등급 계산
  - 캐싱(권장: 60~180초)
  - 로깅/모니터링

```
[Client] --(lat,lng,radius)--> [/api/emergency/nearby]
   [/api/emergency/nearby] --(ServiceKey 포함)--> [Public OpenAPI(XML)]
   [/api/emergency/nearby] --(parse + score + cache)--> [Client]
```

---

## 5. 혼잡도(추정) 산정 로직 (안전한 형태)

### 5.1 원칙
- “혼잡도”는 공공데이터가 직접 제공하는 값이 아니라,
  - `가용응급실자원`(예: 가용병상 수 등) / `전체자원`(가능 시)  
  등을 바탕으로 내부적으로 “추정 등급”을 부여한다.

### 5.2 예시(3단계)
- **여유**: 가용병상(또는 가용자원) ≥ T_high  
- **보통**: T_low ≤ 가용병상 < T_high  
- **혼잡**: 가용병상 < T_low  
- T_high/T_low는 지역/데이터 품질에 따라 조정(초기: 경험적 설정 후 로그 기반 튜닝)

> 전체 병상(denominator)이 제공되지 않는 API라면, “가용병상 절대값”으로만 등급화하되  
> **‘추정’** 표기와 **면책 문구**를 강화한다.

---

## 6. API 연동 구현 가이드 (개발 체크리스트)

### 6.1 서버 라우트 설계 (예)
- `GET /api/emergency/nearby?lat=...&lng=...&radiusKm=...`
- 입력 검증
  - lat/lng 범위
  - radiusKm 허용값(3/5/10)
- 공공 API 호출
  - timeout(예: 3~6초)
  - 재시도(1회)
- XML → JSON
- 표준 응답 스키마로 정규화

### 6.2 표준 응답 스키마(권장)
```json
{
  "generatedAt": "2025-12-21T08:30:00+09:00",
  "source": "NMC/EMC OpenAPI",
  "params": { "lat": 37.39, "lng": 126.95, "radiusKm": 5 },
  "items": [
    {
      "id": "기관코드또는해시",
      "name": "OO병원 응급실",
      "address": "경기도 ...",
      "tel": "031-xxx-xxxx",
      "distanceKm": 2.3,
      "capacity": { "availableBeds": 3, "totalBeds": null },
      "crowding": { "level": "YELLOW", "label": "보통", "note": "추정" },
      "updatedAt": "2025-12-21T08:29:00+09:00"
    }
  ]
}
```

### 6.3 캐싱/쿼터 관리
- 공공 API는 트래픽 제한이 존재(개발계정/운영계정 쿼터 상이)  
- 권장:
  - **서버 캐시 60~180초**
  - 동일 좌표 근접 요청은 라운딩(예: lat/lng 소수 3자리)하여 캐시 히트율 상승

### 6.4 장애/에러 처리
- 공공 API 실패 시:
  - “현재 데이터를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.”  
  - 마지막 캐시 데이터가 있으면 “마지막 업데이트 시각”과 함께 제공(옵션)
- 응답이 0건일 때:
  - 반경 확대/주소 재입력 안내

---

## 7. CRM(어드민) 활용 포인트 (옵션)

### 7.1 상담 로그 연동(추천)
- 환자가 “응급 안내” 페이지를 열었는지 이벤트 기록  
- CRM에서:
  - 야간/휴일 문의가 많은 유형 추적
  - “응급 안내 진입 → 상담 연결” 전환율 측정

### 7.2 이벤트/리포트 테이블(예: Supabase)
- `patient_events`
  - id, user_id, event_type, meta(jsonb), created_at
- event_type 예:
  - `emergency_page_view`
  - `emergency_call_click`
  - `emergency_map_click`

> 의료정보(민감정보) 저장은 최소화. “행동 이벤트” 중심으로 저장.

---

## 8. 의료법/표현 리스크 관리 체크리스트

### 8.1 반드시 지킬 것
- “응급 여부를 판단/확정”하는 문구 금지
- “혼잡도 수치(정확한 %)”처럼 확정적 표현 금지(가능하면 “추정/참고” 표기)
- “이 병원으로 가세요” 같은 추천/유도 표현 금지(중립적 정보 제공)

### 8.2 권장 문구
- “참고 정보”
- “추정”
- “실제와 다를 수 있음”
- “위급하면 119”

---

## 9. 적용 일정(권장) & 테스트 시나리오

### 9.1 1차(MVP, 2~3일)
- 서버 라우트 1개
- 리스트 UI 1개
- 전화/길찾기 버튼
- 캐싱/에러 처리

### 9.2 2차(고도화)
- 혼잡도 등급 튜닝(로그 기반)
- 지도 보기
- CRM 이벤트 분석 대시보드

### 9.3 테스트 체크
- 다양한 좌표(서울/경기)에서 결과 0건 여부
- QT(요일) 등 파라미터가 있는 API라면 KST 기준 확인
- ServiceKey 인코딩(이중 인코딩) 여부
- 공공 API 결과가 “정상(00)”인지 resultCode 확인

---

## 10. 붙여넣기용 UI 카피(요약)

- 메뉴명: **응급 안내(참고용)**
- 페이지 타이틀: **가까운 응급의료기관 찾기**
- 설명: “실시간 가용자원 기반 정보이며 실제와 다를 수 있습니다.”
- 고정 경고: “위급하다고 느끼면 119 또는 가까운 응급실로 연락하세요.”
- 배지: “혼잡도(추정)”
- 버튼: “전화하기”, “길찾기”, “다시 조회”

---

## 부록 A. 개발자 메모
- 공공데이터포털 API는 XML 응답이 기본인 경우가 많음  
- 서버에서 XML 파싱 후 클라이언트에는 JSON만 제공 권장  
- 서비스키는 **절대 클라이언트에 노출 금지**(Vercel 환경변수 사용)

---

## 부록 B. 다음 단계(평촌이생각치과 맥락 연결)
본 기능은 **“치과 조회(1순위) → 헬스체크(2순위)”** 구조와 별개로,  
환자 안전과 야간/휴일 문의 대응을 강화하는 “보조 안전 기능”으로 배치하는 것을 권장합니다.

- 히어로(헬스케어)에서 바로 노출하기보다는  
  **FAQ/챗봇/하단 메뉴**로 접근시키는 방식이 오인 리스크가 낮고 운영에도 유리합니다.
